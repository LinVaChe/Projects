from sqlalchemy.orm import Session
from backend.models import User, Product, ProductProperty
from passlib.context import CryptContext

pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

def create_test_data(db: Session):
    """Создает тестовые данные для проекта при первом запуске."""

    # --- 1. Тестовый пользователь ---
    if db.query(User).count() == 0:
        print("Создание тестового пользователя...")
        admin_user = User(
            username="admin",
            email="admin@example.com",
            sex="none",
            paytype="none",
            country="none",
            infoabout="Тестовый пользователь",
            password_hash=pwd_context.hash("user"),
            access_token=""
        )
        db.add(admin_user)
        db.commit()
        print("Администратор создан: login=admin, password=admin")

    # --- 2. Товары ---
    if db.query(Product).count() == 0:
        print("Создание товаров...")

        products_data = [
            # hall
            {
                "name": 'Модуль "Серость"',
                "category": "hall",
                "short_description": "Стильный набор мебели для коридора с современным дизайном.",
                "description": "Полное описание из SQL...",
                "price": 28900,
                "image": "/static/pics/lot_1_1.jpg",
                "properties": [
                    ("Материал корпуса","ЛДСП, влагостойкое покрытие"),
                    ("Материал фасадов","МДФ SoftTouch"),
                    ("Цвет корпуса","Светло-серый (Concrete Grey)"),
                    ("Цвет фасадов","Графит"),
                    ("Количество дверей","3"),
                    ("Количество ящиков","2"),
                    ("Тип ручек","Push-to-open"),
                    ("Особенности","Плавное закрывание, регулируемые полки, перекладина"),
                    ("Варианты установки","Напольный, возможное крепление к стене"),
                    ("Стиль","Современный минимализм"),
                    ("Габариты","1200 × 2100 × 500 мм"),
                    ("Вес","86 кг"),
                    ("Гарантия","24 месяца")
                ]
            },
            {
                "name": 'Модуль "Бежевый шик"',
                "category": "hall",
                "short_description": "Элегантный модуль в бежево-белой палитре с зеркалом и практичными полками.",
                "description": "Полное описание из SQL...",
                "price": 31200,
                "image": "/static/pics/lot_1_2.webp",
                "properties": [
                    ("Материал корпуса","ЛДСП с декоративным шпоном"),
                    ("Материал фасадов","МДФ с матовым покрытием"),
                    ("Цвет","Бежевый (Cream Beige)"),
                    ("Оснащение","зеркало, выдвижной ящик, полки для обуви, отдел с перекладиной"),
                    ("Особенности","скрытые ручки, плавное закрывание, возможность навесного крепления"),
                    ("Стиль","Современный / Неоклассика"),
                    ("Габариты","1100 × 2000 × 400 мм"),
                    ("Гарантия","24 месяца")
                ]
            },
            {
                "name": 'Модуль "Тёплое дерево"',
                "category": "hall",
                "short_description": "Стильный модуль с отделкой под натуральный дуб и удобной функциональной компоновкой.",
                "description": "Полное описание из SQL...",
                "price": 33500,
                "image": "/static/pics/lot_1_3.jpg",
                "properties": [
                    ("Материал корпуса","ЛДСП с текстурой дуба"),
                    ("Материал фасадов","МДФ под натуральное дерево"),
                    ("Цвет","Натуральный дуб / Светлый орех"),
                    ("Оснащение","крючки, зеркало, тумба для обуви, отдел для верхней одежды"),
                    ("Особенности","устойчивая конструкция, лёгкий уход, стыковка с другими модулями"),
                    ("Стиль","Эко / Скандинавский"),
                    ("Габариты","1200 × 2100 × 450 мм"),
                    ("Гарантия","24 месяца")
                ]
            },
            # sofa
            {
                "name": 'Диван "Жители ковра"',
                "category": "sofa",
                "short_description": "Прямой диван ярко-жёлтого цвета — идеален для компаний и больших семей.",
                "description": "Полное описание из SQL...",
                "price": 54900,
                "image": "/static/pics/lot_2_1.webp",
                "properties": [
                    ("Тип","прямой диван среднего размера"),
                    ("Материал каркаса","массив дерева, фанера"),
                    ("Обивка","износостойкий велюр"),
                    ("Цвет","Ярко-жёлтый (Honey Mustard)"),
                    ("Механизм трансформации","отсутствует"),
                    ("Наполнение","ППУ повышенной плотности"),
                    ("Особенности","съёмные подушки, металлические ножки, простая чистка"),
                    ("Стиль","Современный / Лофт"),
                    ("Габариты","2000 × 850 × 900 мм"),
                    ("Гарантия","18 месяцев")
                ]
            },
            {
                "name": 'Диван "Голубая мгла"',
                "category": "sofa",
                "short_description": "Компактный раскладной диван нежно-голубого оттенка с механизмом еврокнижка.",
                "description": "Полное описание из SQL...",
                "price": 61800,
                "image": "/static/pics/lot_2_2.webp",
                "properties": [
                    ("Материал каркаса","металл + берёзовая фанера"),
                    ("Обивка","микровельвет нежно-голубого цвета"),
                    ("Механизм трансформации","еврокнижка"),
                    ("Наполнение","пружинный блок + ППУ"),
                    ("Бельевой ящик","есть"),
                    ("Особенности","лёгкое раскладывание, съёмные чехлы"),
                    ("Стиль","Современный минимализм / Сканди"),
                    ("Габариты","2100 × 900 × 950 мм (спальное место 1400 × 2000 мм)"),
                    ("Гарантия","24 месяца")
                ]
            },
            {
                "name": 'Диван "Бежевый простор"',
                "category": "sofa",
                "short_description": "Большой П-образный модульный диван в универсальном бежевом оттенке.",
                "description": "Полное описание из SQL...",
                "price": 96500,
                "image": "/static/pics/lot_2_3.webp",
                "properties": [
                    ("Тип","большой модульный П-образный диван"),
                    ("Материал каркаса","дерево, металл"),
                    ("Обивка","рогожка бежевого цвета"),
                    ("Механизм","модульная сборка, возможна трансформация в спальное место"),
                    ("Наполнение","пружинный блок + пенополиуретан"),
                    ("Особенности","регулируемые подголовники, переставляемые секции"),
                    ("Стиль","Современный / Комфорт-класс"),
                    ("Габариты","3400 × 900 × 2200 мм"),
                    ("Гарантия","24 месяца")
                ]
            },
            # wardrobe
            {
                "name": 'Шкаф "Савен"',
                "category": "wardrobe",
                "short_description": "Большой шкаф для верхней одежды и хранения.",
                "description": "Полное описание из SQL...",
                "price": 32990,
                "image": "/static/pics/lot_3_1.jpg",
                "properties": [
                    ("Тип","четырёхстворчатый шкаф для одежды"),
                    ("Материал корпуса","ЛДСП премиум-класса"),
                    ("Материал фасадов","МДФ, матовая эмаль SoftTouch"),
                    ("Цвет","Белый (Arctic White)"),
                    ("Количество дверей","4 распашные"),
                    ("Оснащение","перекладины, полки, нижние ящики"),
                    ("Особенности","скрытые ручки, плавное закрывание"),
                    ("Стиль","Современная классика / Минимализм"),
                    ("Габариты","1800 × 2500 × 600 мм"),
                    ("Гарантия","24 месяца")
                ]
            },
            {
                "name": 'Шкаф-купе "Скайлайн"',
                "category": "wardrobe",
                "short_description": "Трёхсекционный шкаф-купе под потолок.",
                "description": "Полное описание из SQL...",
                "price": 35990,
                "image": "/static/pics/lot_3_2.webp",
                "properties": [
                    ("Тип","трёхсекционный шкаф-купе"),
                    ("Материал корпуса","ЛДСП"),
                    ("Материал фасадов","МДФ, матовое покрытие"),
                    ("Цвет корпуса","Белый"),
                    ("Цвет вставок","Венге / графит"),
                    ("Количество дверей","3 раздвижные"),
                    ("Оснащение","регулируемые полки, перекладина, антресоль"),
                    ("Особенности","система плавного закрывания"),
                    ("Стиль","Современный минимализм"),
                    ("Габариты","2400 × 2600 × 600 мм"),
                    ("Гарантия","24 месяца")
                ]
            },
            {
                "name": 'Шкаф "Сахарная вата"',
                "category": "wardrobe",
                "short_description": "Детский розово-белый шкаф.",
                "description": "Полное описание из SQL...",
                "price": 28990,
                "image": "/static/pics/lot_3_3.webp",
                "properties": [
                    ("Тип","детский шкаф"),
                    ("Материал корпуса","ЛДСП"),
                    ("Материал фасадов","МДФ SoftTouch"),
                    ("Цвет корпуса","Белый"),
                    ("Цвет фасадов","Нежно-розовый"),
                    ("Количество ящиков","6"),
                    ("Количество секций","2"),
                    ("Особенности","безопасная фурнитура, плавное закрывание"),
                    ("Стиль","Современная детская / Скандинавский"),
                    ("Габариты","1200 × 2000 × 500 мм"),
                    ("Гарантия","24 месяца")
                ]
            },
            # bed
            {
                "name": 'Кровать "Серый уют"',
                "category": "bed",
                "short_description": "Двуспальная кровать в сером цвете.",
                "description": "Полное описание из SQL...",
                "price": 26990,
                "image": "/static/pics/lot_4_1.webp",
                "properties": [
                    ("Материал корпуса","ЛДСП"),
                    ("Материал обивки","ткань, износостойкая"),
                    ("Цвет","Светло-серый"),
                    ("Тип основания","ортопедическое, ламели"),
                    ("Изголовье","мягкое, вертикальная простёжка"),
                    ("Размер спального места","160 × 200 см"),
                    ("Опции","подъёмный механизм, ящик для белья"),
                    ("Стиль","Современный минимализм"),
                    ("Габариты","1700 × 1000 × 2100 мм"),
                    ("Гарантия","24 месяца")
                ]
            },
            {
                "name": 'Кровать "Белый комфорт"',
                "category": "bed",
                "short_description": "Элегантная белая кровать с мягким изголовьем.",
                "description": "Полное описание из SQL...",
                "price": 29990,
                "image": "/static/pics/lot_4_2.webp",
                "properties": [
                    ("Материал корпуса","ЛДСП"),
                    ("Материал обивки","Эко-кожа"),
                    ("Цвет","Белый с бежевыми акцентами"),
                    ("Тип основания","ортопедическое, металлический каркас"),
                    ("Изголовье","мягкое, ромбическая простёжка"),
                    ("Размер спального места","180 × 200 см"),
                    ("Особенности","лёгкий уход, устойчивость к влаге"),
                    ("Стиль","Современная классика"),
                    ("Габариты","1900 × 1100 × 2150 мм"),
                    ("Гарантия","24 месяца")
                ]
            }
        ]

        for prod in products_data:
            product = Product(
                productname=prod["name"],
                category=prod["category"],
                short_description=prod["short_description"],
                description=prod["description"],
                price=prod["price"],
                image=prod["image"],
                available=True
            )
            db.add(product)
            db.commit()
            db.refresh(product)

            for prop_name, prop_value in prod["properties"]:
                property_entry = ProductProperty(
                    productid=product.productid,
                    property_name=prop_name,
                    property_value=prop_value
                )
                db.add(property_entry)
            db.commit()

        print(f"Создано {len(products_data)} товаров с их свойствами")

    print("Инициализация тестовых данных завершена!")
